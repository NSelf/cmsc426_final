%% CMSC 426: Project 5 Helper Code
% Written by: Nitin J. Sanket (nitinsan@terpmail.umd.edu)
% PhD in CS Student at University of Maryland, College Park
% Acknowledgements: Bhoram Lee of University of Pennsylvania for help with depthToCloud function

clc
clear all
close all

%% Setup Paths and Read RGB and Depth Images
Path = '../Data/SingleObject/'; 
SceneNum = 1;
SceneName = sprintf('%0.3d', SceneNum);
FrameNum = num2str(1);

I = imread([Path,'scene_',SceneName,'/frames/frame_',FrameNum,'_rgb.png']);
ID = imread([Path,'scene_',SceneName,'/frames/frame_',FrameNum,'_depth.png']);

%% Extract 3D Point cloud
% Inputs:
% ID - the depth image
% I - the RGB image
% calib_file - calibration data path (.mat) 
%              ex) './param/calib_xtion.mat'
%              
% Outputs:
% pcx, pcy, pcz    - point cloud (valid points only, in RGB camera coordinate frame)
% r,g,b            - color of {pcx, pcy, pcz}
% D_               - registered z image (NaN for invalid pixel) 
% X,Y              - registered x and y image (NaN for invalid pixel)
% validInd	   - indices of pixels that are not NaN or zero
% NOTE:
% - pcz equals to D_(validInd)
% - pcx equals to X(validInd)
% - pcy equals to Y(validInd)

[pcx, pcy, pcz, r, g, b, D_, X, Y,validInd] = depthToCloud_full_RGB(ID, I, './params/calib_xtion.mat');
Pts = [pcx pcy pcz];

%% Display Images and 3D Points
% Note this needs the computer vision toolbox.
figure,
subplot 121
imshow(I);
title('RGB Input Image');
subplot 122
imagesc(ID);
title('Depth Input Image');

figure,
pcshow(Pts,[r g b]/255);
drawnow;
title('3D Point Cloud');

%% Noise exclusion by radius from center of foreground
toDel = [];
center = [0, 0, 0];
radius = 1200;

for i = 1:length(Pts)
    dist = norm(Pts(i, :) - center);
    if dist > radius
        toDel = [toDel; i];
    else
        dist;
    end
end

newPts = Pts;
newPts(toDel, :) = [];
r(toDel) = [];
g(toDel) = [];
b(toDel) = [];

figure(),
pcshow(newPts, [r g b]/255);
drawnow;
Pts = newPts;

%% RANSAC for background plane removal
ransacRuns = 2;
for i = 1:ransacRuns
    test = ransac_point_cloud(Pts);
    hold on;
    plot(test{1});
    hold off;
    
    newPts = Pts;
    newPts(test{2}, :) = [];

    figure(),
    pcshow(newPts);
    drawnow;
    title(['3D Point Cloud after ', num2str(i), ' RANSAC runs for plane']);
    Pts = newPts;
end


%% Avg distance noise suppression

center = mean(Pts);
dist = zeros(length(Pts), 1);
for i = 1:length(Pts)
    dist(i) = norm(center - Pts(i));
end










